# DNS и DHCP

## Зачем нужна служба DNS

Числовая IP-адресация не неудобна для человека. Запомнить наборы цифр гораздо труднее, чем слова. Для облегчения стали использовать соответствия числовых адресов именам машин.

Например, для нашего сервера существуют следующие соответствия:

```
127.0.0.1 localhost
195.208.44.20 ipm.kstu.ru
195.208.44.20 www.ipm.kstu.ru
```

Длина имени не более 63 символов. Сначала такие соответствия просто сами записывали в файл, брали у знакомых и копировали с FTP-серверов. Это файлы имеет название hosts, и находится в каталогах:

- Для UNIX - /etc/hosts
- Для Windows - C:\windows\system32\drivers\etc\hosts

Можете сами изменить его, например, внеся запись:

195.208.44.20 ipm

Теперь вы можете, просто набрав в браузере ipm попасть на сервер www.ipm.kstu.ru. Таким образом, вы можете записать любой сервер.

Однако такой способ присвоения символьных имен был хорош до тех пор, пока Internet был маленьким. По мере роста сети стало затруднительным поддерживать большие списки имен на каждом компьютере. Для того, что бы решить эту проблему, были придумана служба DNS (Domain Name System).

## Принципы организации DNS

Первый стандарт DNS определен в RFC0883 (Domain names: Implementation specification P.V. Mockapetris Nov-01-1983) и RFC0882 (Domain names: Concepts and facilities P.V. Mockapetris Nov-01-1983)

Последняя версия RFC1034 (Domain names - concepts and facilities P.V. Mockapetris Nov-01-1987) и RFC1035 (Domain names - implementation and specification P.V. Mockapetris Nov-01-1987)

Система доменных адресов строится по иерархическому принципу. Администрирование начинается с доменов верхнего, или первого, уровня.

Первые домены верхнего уровня были рассчитаны на США:

- gov - государственные организации
- mil - военные учреждения
- edu - образовательные учреждения
- com - коммерческие организации
- net - сетевые организации

Позднее, когда сеть перешагнула национальные границы США появились национальные домены типа:

- uk - Объединенное королевство
- jp - Япония
- au - Австралия
- ch - Чехия
- su - СССР
- ru - Россия

IANA - The Internet Assigned Numbers Authority (Управление назначением адресов в Internet) - организация, осуществляющая контроль над распределением доменов первого уровня. Сервер http://www.iana.org/

Базу можно посмотреть по адресу whois.iana.org

Вслед за доменами первого уровня следуют домены, либо географические (kazan.ru, tatarstan.ru), либо организации (kstu.ru). В настоящее время практически любая организация или физическое лицо может получить свой собственный домен второго уровня (сервер РосНИИРОС - www.ripn.net ).

Далее идут домены третьего уровня, например :

- efir.kazan.ru
- ipm.kstu.ru
- www.kstu.ru - тоже домен третьего уровня.

Систему доменной адресации можно представить следующим образом:

![Alt text](https://moodle.kstu.ru/pluginfile.php/179/mod_page/content/1/2-1.gif)

Служба доменных имен работает как распределенная база, данные которой распределены по DNS-серверам.

Система доменных имен - это сервис прикладного уровня, значит, использует транспорт TCP и UDP.

Порт по умолчанию - 53.

Сервис DNS строится по схеме "клиент-сервер". В качестве клиентской части выступает процедура разрешения имен - resolver, а в качестве сервера DNS-сервер (BIND ...).

![Alt text](https://moodle.kstu.ru/pluginfile.php/179/mod_page/content/1/2-5.gif)

Например, когда мы хотим обратиться к серверу ipm.kstu.ru, ваш браузер, используя resolver, поступает следующим образом:

1. ищет запись ipm.kstu.ru в файле hosts, если не находит, то,
2. посылает запрос на известный DNS-кэширующий сервер (как правило, локальный), если на этом сервере запись не найдена, то,
3. сервер DNS-кэширующий обращается к DNS-ROOT серверу с запросом адреса DNS сервера отвечающего за домен первого уровня ru, если получает адрес, то,
4. сервер DNS-кэширующий обращается к DNS серверу, отвечающего за домен первого уровня ru, с запросом адреса DNS сервера отвечающего за домен второго уровня kstu.ru, если получает адрес, то,
5. сервер DNS-кэширующий посылает запрос на DNS сервер, отвечающий за домен второго уровня kstu.ru, если получает адрес, то,
6. сервер DNS-кэширующий адрес кэширует и передает клиенту
7. клиент обращается по IP адресу - 195.208.44.20

![Alt text](https://moodle.kstu.ru/pluginfile.php/179/mod_page/content/1/2-2.gif)

## Некоторые типы DNS-серверов

Первичный - сервер, содержащий полную информацию о зоне.

Вторичный - сервер, содержащий копию полной информации о зоне, полученную с первичного сервера.

Кэширующий - содержит записи, которые уже были запрошены

## Формат DNS-сообщения

![Alt text](https://moodle.kstu.ru/pluginfile.php/179/mod_page/content/1/2-3.gif)
![Alt text](https://moodle.kstu.ru/pluginfile.php/179/mod_page/content/1/2-4.gif)

QR - Операция:
0 Запрос
1 Отклик

Тип запроса -
0 стандартный
1 инверсный
2 запрос состояния сервера

AA - Равен 1 при ответе от сервера, в ведении которого находится домен, упомянутый в запросе.

TC - Равен при укорочении сообщения. Для UDP это означает, что ответ содержал более 512 байт, но прислано только первые 512.

RD - Равен 1, если для получения ответа желательна рекурсия.

RA - Равен 1, если рекурсия для запрашиваемого сервера доступна.

Нули - Зарезервировано на будущее..

Тип отклика -
0 нет ошибки
1 ошибка в формате запроса
2 сбой в сервере
3 имени не существует

## Служба DHCP

DHCP (Dynamic Host Configuration Protocol) - протокол динамической конфигурации хоста. DHCP является расширением и дополнением протокола BOOTP, который предназначен для выдачи IP-адресов бездисковым машинам.

Используется транспортный протокол UDP.

DHCP построен по схеме клиент-сервер.

Сервер должен отвечать на пакеты с IP-адресом 255.255.255.255, т.к. клиент может не знать где находится (какая IP-сеть, какой IP-адрес у DHCP).

Порт сервера по умолчанию 67.

Порт клиента по умолчанию 68.

Механизмы выделения IP-адресов сервером DHCP:

- Динамическое присвоение - присваивает клиенту IP-адрес на ограниченное время.
- Ручное выделение - IP-адрес клиента привязывается к адресу канального уровня (MAC-адрес для Ethrnet) клиента в базе DHCP, сетевым администратором.

Основные компоненты службы:

- DHCP клиент
- DHCP сервер
- Relay Agent (агент пересылки) BOOTP - хост (маршрутизатор), который осуществляет связь между клиентом и сервером DHCP. В 2001г принят стандарт DHCP Relay Agent - RFC3046, и в следующей версии, наверное, будет DHCP Relay Agent вместо Relay Agent BOOTP. В старой версии (RFC0951) Relay Agent назывался BOOTP forwarding agents.
- Binding (сопряжение) - совокупность конфигурационных параметров, включая, как минимум, IP-адрес, присваиваемый DHCP-клиенту.

## Протокол BOOTP

Создан для загрузки бездисковых машин.

Стандарт BOOTP - RFC0951 (Bootstrap Protocol W.J. Croft, J. Gilmore Sep-01-1985).

Последняя версия дополнений для BOOTP - RFC1542 (Clarifications and Extensions for the Bootstrap Protocol W. Wimer October 1993). Введено понятие Relay Agent.

Первая версия расширения разработчиков (поле vend) для BOOTP - RFC1048 (BOOTP vendor information extensions P.A. Prindeville Feb-01-1988).

Последняя версия расширения разработчиков (поле vend) для BOOTP - RFC2132 (DHCP Options and BOOTP Vendor Extensions S. Alexander, R. Droms March 1997).

BOOTP является прототипом DHCP, в DHCP есть все что было в BOOTP.

## Протокол DHCP

Первый стандарт DHCP - RFC1531 (Dynamic Host Configuration Protocol R. Droms October 1993).

Последняя версия DHCP - RFC2131 (Dynamic Host Configuration Protocol R. Droms March 1997).

Последняя DHCP версия для IPv6 - RFC3315 (Dynamic Host Configuration Protocol for IPv6 (DHCPv6) R. Droms, Ed., J. Bound, B. Volz, T. Lemon, C. Perkins, M. Carney July 2003).

Последняя версия дополнительных параметров (поле OPTIONS) для DHCP - RFC2132 (DHCP Options and BOOTP Vendor Extensions S. Alexander, R. Droms March 1997).

![Alt text](https://moodle.kstu.ru/pluginfile.php/222/mod_page/content/1/12-1.gif)

## Механизм динамического выделения адресов

Выделение происходит при обмене сообщений между сервером и клиентом.

Алгоритм получения:

1. Клиент посылается широковещательный (BROADCAST-255.255.255.255) запрос DHCPDISCOVER всем серверам DHCP.
2. Все активные серверы посылают широковещательный ответ DHCPOFFER. Клиент принимает все ответы, инициализацию делает по адресу канального уровня (MAC-адрес для Ethrnet).
3. Клиент выбирает один из предложенных адресов и посылает широковещательно DHCPREQUEST, которое должно содержать параметр Server Identifier (поле OPTIONS), чтобы указать, какой сервер им выбран.
4. Сервер посылает широковещательно DHCPACK.
5. Клиент может работать.

![Alt text](https://moodle.kstu.ru/pluginfile.php/222/mod_page/content/1/12-2.gif)

## База записей DHCP

```
lease 194.85.241.234 { // Выданный IP-адрес
starts 1 2003/11/17 11:42:13; // Время выдачи
ends 1 2003/11/17 17:42:13; // Время истечения срока аренды
binding state active; // Состояние сопряжения активно (время не истекло)
next binding state free; // Следующее состояние сопряжения свободно (после истечения времени)
hardware ethernet 00:50:22:bb:c0:0d; // etherne
```
